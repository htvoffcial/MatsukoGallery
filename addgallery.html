<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像アップロードとWebP変換</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    input, button, textarea { margin: 5px 0; display: block; width: 100%; }
    #tagDisplay span { display: inline-block; padding: 4px 8px; background: #eef; margin: 2px; border-radius: 4px; }
    #downloadLink { margin-top: 10px; display: none; }
  </style>
</head>
<body>

  <h2>画像アップロードとWebP変換（1MB以下）</h2>

  <label>画像を選択：
    <input type="file" id="imageInput" accept="image/*">
  </label>

  <label>ファイル名（英語のみ、小文字禁止、10文字以内）：
    <input type="text" id="filenameInput" maxlength="10">
  </label>

  <label>タグ入力（Enterで追加）：
    <input type="text" id="tagInput" list="tagSuggestions">
    <datalist id="tagSuggestions">
      <option value="展望台">
      <option value="自然">
      <option value="建築物">
      <option value="空">
      <option value="都市">
      <option value="山">
    </datalist>
  </label>

  <div id="tagDisplay"></div>

  <button id="convertButton">WebP変換＆ダウンロードリンク生成</button>

  <a id="downloadLink" download>→ ダウンロードリンク</a>

  <textarea id="outputJson" rows="8" readonly></textarea>

  <script>
    const tagInput = document.getElementById("tagInput");
    const tagDisplay = document.getElementById("tagDisplay");
    const tags = new Set();

    tagInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const tag = tagInput.value.trim();
        if (tag && !tags.has(tag)) {
          tags.add(tag);
          const span = document.createElement("span");
          span.textContent = tag;
          tagDisplay.appendChild(span);
        }
        tagInput.value = "";
      }
    });

    let existingPaths = [];

    async function fetchGalleryJson() {
      try {
        const res = await fetch("gallery.json");
        if (res.ok) {
          const data = await res.json();
          existingPaths = data.map(entry => entry.path.match(/\/images\/(\d+)_/)?.[1]).filter(Boolean);
        }
      } catch (e) {
        console.warn("gallery.json の読み込みに失敗しました", e);
      }
    }

    fetchGalleryJson();

    document.getElementById("convertButton").addEventListener("click", async () => {
      const file = document.getElementById("imageInput").files[0];
      const filename = document.getElementById("filenameInput").value.trim();
      const downloadLink = document.getElementById("downloadLink");
      const outputJson = document.getElementById("outputJson");

      if (!file || !filename || tags.size === 0) {
        alert("全項目を入力してください");
        return;
      }

      if (!/^[A-Z0-9-]+$/.test(filename)) {
        alert("ファイル名は大文字英数字とハイフンのみです");
        return;
      }

      const img = new Image();
      img.src = URL.createObjectURL(file);
      await img.decode();

      // Resize: 最大幅1024pxに調整
      const MAX_WIDTH = 1024;
      const scale = Math.min(1, MAX_WIDTH / img.width);
      const canvas = document.createElement("canvas");
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // WebPエンコード
      let quality = 0.95;
      let blob;
      do {
        blob = await new Promise(res => canvas.toBlob(res, "image/webp", quality));
        quality -= 0.05;
      } while (blob.size > 1024 * 1024 && quality > 0.5); // 1MB以下目標

      // 重複しないID生成
      let newId;
      do {
        newId = Math.floor(1000 + Math.random() * 9000).toString();
      } while (existingPaths.includes(newId));

      const newPath = `/images/${newId}_${filename}.webp`;

      // ダウンロードリンク生成
      const blobUrl = URL.createObjectURL(blob);
      downloadLink.href = blobUrl;
      downloadLink.download = `${newId}_${filename}.webp`;
      downloadLink.style.display = "inline";
      downloadLink.textContent = `→ ${newId}_${filename}.webp をダウンロード`;

      // JSON構造出力
      const newEntry = {
        path: newPath,
        tag: [...tags]
      };
      outputJson.value = JSON.stringify(newEntry, null, 2);
    });
  </script>

</body>
</html>
