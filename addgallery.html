<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨WebPå¤‰æ›</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600&display=swap');
    body { font-family: 'Noto Sans JP', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
    .tag-item { transition: all 0.2s ease; }
    .tag-item:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .upload-area { transition: all 0.3s ease; }
    .upload-area:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    .progress-bar { transition: width 0.3s ease; }
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-2xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-white mb-2">ğŸ“¸ WebPå¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>
      <p class="text-white/80">ç”»åƒã‚’é«˜å“è³ªãªWebPå½¢å¼ã«å¤‰æ›ï¼ˆ1MBä»¥ä¸‹ï¼‰</p>
    </div>

    <!-- Main Card -->
    <div class="glass-effect rounded-2xl p-8 shadow-2xl border border-white/20">
      
      <!-- Image Upload Section -->
      <div class="mb-6">
        <label class="block text-white font-medium mb-3">ğŸ“ ç”»åƒã‚’é¸æŠ</label>
        <div class="upload-area bg-white/10 border-2 border-dashed border-white/30 rounded-xl p-6 text-center cursor-pointer hover:border-white/50">
          <input type="file" id="imageInput" accept="image/*" class="hidden">
          <div id="uploadText" class="text-white/80">
            <div class="text-4xl mb-2">â¬†ï¸</div>
            <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ</p>
            <p class="text-sm mt-1">JPG, PNG, GIFå¯¾å¿œ</p>
          </div>
          <div id="imagePreview" class="hidden">
            <img id="previewImg" class="max-w-full max-h-48 mx-auto rounded-lg shadow-lg">
            <p id="fileName" class="text-white mt-2 font-medium"></p>
          </div>
        </div>
      </div>

      <!-- Filename Input -->
      <div class="mb-6">
        <label class="block text-white font-medium mb-3">âœï¸ ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆè‹±èªã®ã¿ã€å¤§æ–‡å­—ã€10æ–‡å­—ä»¥å†…ï¼‰</label>
        <input type="text" id="filenameInput" maxlength="10" 
               class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/30 focus:border-white/50"
               placeholder="ä¾‹: SUNSET-VIEW">
        <p class="text-white/60 text-sm mt-1">å¤§æ–‡å­—è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½</p>
      </div>

      <!-- Tags Section -->
      <div class="mb-6">
        <label class="block text-white font-medium mb-3">ğŸ·ï¸ ã‚¿ã‚°å…¥åŠ›ï¼ˆEnterã§è¿½åŠ ï¼‰</label>
        <input type="text" id="tagInput" list="tagSuggestions"
               class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/30 focus:border-white/50"
               placeholder="ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã¦Enterã‚­ãƒ¼">
        <datalist id="tagSuggestions">
          <option value="å±•æœ›å°">
          <option value="è‡ªç„¶">
          <option value="å»ºç¯‰ç‰©">
          <option value="ç©º">
          <option value="éƒ½å¸‚">
          <option value="å±±">
          <option value="æµ·">
          <option value="å¤•æ—¥">
          <option value="å¤œæ™¯">
          <option value="æ¡œ">
        </datalist>
        
        <!-- Tags Display -->
        <div id="tagDisplay" class="mt-3 flex flex-wrap gap-2"></div>
      </div>

      <!-- Convert Button -->
      <button id="convertButton" 
              class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold py-4 px-6 rounded-xl hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
        ğŸ”„ WebPå¤‰æ›ï¼†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ç”Ÿæˆ
      </button>

      <!-- Progress Bar -->
      <div id="progressContainer" class="hidden mt-4">
        <div class="bg-white/20 rounded-full h-2">
          <div id="progressBar" class="progress-bar bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-white/80 text-sm mt-2 text-center">å¤‰æ›ä¸­...</p>
      </div>

      <!-- Download Link -->
      <div id="downloadSection" class="hidden mt-6 p-4 bg-green-500/20 rounded-xl border border-green-400/30">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-white font-medium">âœ… å¤‰æ›å®Œäº†ï¼</p>
            <p class="text-white/80 text-sm">ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: <span id="fileSize"></span></p>
          </div>
          <a id="downloadLink" download 
             class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
            ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </a>
        </div>
      </div>

      <!-- JSON Output -->
      <div class="mt-6">
        <label class="block text-white font-medium mb-3">ğŸ“‹ JSONå‡ºåŠ›</label>
        <textarea id="outputJson" rows="8" readonly
                  class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/30 font-mono text-sm resize-none"
                  placeholder="å¤‰æ›å¾Œã®JSONæƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
      </div>
    </div>
  </div>

  <script>
    const tagInput = document.getElementById("tagInput");
    const tagDisplay = document.getElementById("tagDisplay");
    const imageInput = document.getElementById("imageInput");
    const uploadArea = document.querySelector(".upload-area");
    const uploadText = document.getElementById("uploadText");
    const imagePreview = document.getElementById("imagePreview");
    const previewImg = document.getElementById("previewImg");
    const fileName = document.getElementById("fileName");
    const convertButton = document.getElementById("convertButton");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const downloadSection = document.getElementById("downloadSection");
    const downloadLink = document.getElementById("downloadLink");
    const fileSize = document.getElementById("fileSize");
    const outputJson = document.getElementById("outputJson");
    
    const tags = new Set();
    let existingPaths = [];

    // Upload area click handler
    uploadArea.addEventListener("click", () => imageInput.click());

    // Drag and drop functionality
    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "rgba(255,255,255,0.7)";
    });

    uploadArea.addEventListener("dragleave", () => {
      uploadArea.style.borderColor = "rgba(255,255,255,0.3)";
    });

    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "rgba(255,255,255,0.3)";
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        imageInput.files = files;
        handleImageSelect();
      }
    });

    // Image selection handler
    imageInput.addEventListener("change", handleImageSelect);

    function handleImageSelect() {
      const file = imageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          fileName.textContent = file.name;
          uploadText.classList.add("hidden");
          imagePreview.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    }

    // Tag input handler
    tagInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const tag = tagInput.value.trim();
        if (tag && !tags.has(tag)) {
          tags.add(tag);
          const span = document.createElement("span");
          span.className = "tag-item inline-block px-3 py-1 bg-white/20 text-white rounded-full text-sm border border-white/30 cursor-pointer";
          span.textContent = tag;
          span.onclick = () => {
            tags.delete(tag);
            span.remove();
          };
          tagDisplay.appendChild(span);
        }
        tagInput.value = "";
      }
    });

    // Fetch existing gallery data
    async function fetchGalleryJson() {
      try {
        const res = await fetch("gallery.json");
        if (res.ok) {
          const data = await res.json();
          existingPaths = data.map(entry => entry.path.match(/\/images\/(\d+)_/)?.[1]).filter(Boolean);
        }
      } catch (e) {
        console.warn("gallery.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
      }
    }

    fetchGalleryJson();

    // Convert button handler
    convertButton.addEventListener("click", async () => {
      const file = imageInput.files[0];
      const filename = document.getElementById("filenameInput").value.trim();

      // Validation
      if (!file) {
        alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }
      if (!filename) {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      if (tags.size === 0) {
        alert("å°‘ãªãã¨ã‚‚1ã¤ã®ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„");
        return;
      }
      if (!/^[A-Z0-9-]+$/.test(filename)) {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«åã¯å¤§æ–‡å­—è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ã§ã™");
        return;
      }

      // Show progress
      convertButton.disabled = true;
      progressContainer.classList.remove("hidden");
      downloadSection.classList.add("hidden");
      
      try {
        // Progress simulation
        for (let i = 0; i <= 30; i += 10) {
          progressBar.style.width = i + "%";
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();

        progressBar.style.width = "50%";
        progressText.textContent = "ç”»åƒã‚’å‡¦ç†ä¸­...";

        // Resize: æœ€å¤§å¹…1024pxã«èª¿æ•´
        const MAX_WIDTH = 1024;
        const scale = Math.min(1, MAX_WIDTH / img.width);
        const canvas = document.createElement("canvas");
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        progressBar.style.width = "70%";
        progressText.textContent = "WebPã«å¤‰æ›ä¸­...";

        // WebPã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        let quality = 0.95;
        let blob;
        do {
          blob = await new Promise(res => canvas.toBlob(res, "image/webp", quality));
          quality -= 0.05;
        } while (blob.size > 1024 * 1024 && quality > 0.5);

        progressBar.style.width = "90%";
        progressText.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ä¸­...";

        // é‡è¤‡ã—ãªã„IDç”Ÿæˆ
        let newId;
        do {
          newId = Math.floor(1000 + Math.random() * 9000).toString();
        } while (existingPaths.includes(newId));

        const newPath = `/images/${newId}_${filename}.webp`;

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ç”Ÿæˆ
        const blobUrl = URL.createObjectURL(blob);
        downloadLink.href = blobUrl;
        downloadLink.download = `${newId}_${filename}.webp`;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºè¡¨ç¤º
        const sizeInKB = (blob.size / 1024).toFixed(1);
        fileSize.textContent = `${sizeInKB} KB`;

        // JSONæ§‹é€ å‡ºåŠ›
        const newEntry = {
          path: newPath,
          filename: `${newId}_${filename}.webp`,
          tags: Array.from(tags),
          size: `${sizeInKB} KB`,
          dimensions: `${canvas.width}x${canvas.height}`,
          created: new Date().toISOString()
        };

        outputJson.value = JSON.stringify(newEntry, null, 2);

        // Complete progress
        progressBar.style.width = "100%";
        progressText.textContent = "å®Œäº†ï¼";
        
        setTimeout(() => {
          progressContainer.classList.add("hidden");
          downloadSection.classList.remove("hidden");
        }, 500);

      } catch (error) {
        alert("å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
        progressContainer.classList.add("hidden");
      } finally {
        convertButton.disabled = false;
      }
    });

    // Filename input validation
    document.getElementById("filenameInput").addEventListener("input", (e) => {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9-]/g, "");
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96b63785a7a15ebc',t:'MTc1NDU2Mzg2Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
